<div id="lc-livechat" class="closed">
	<div class="title">
		<?php echo __('Contact Us'); ?>
	</div>
	<div id="lc-discussion">
		<div id="lc-livedisc"></div>
	</div>
	<form id="lc-livechatform" action="<?php echo $this->getFormAction(); ?>" type="post">
		<textarea id="lc-message" name="message" placeholder="<?php echo __('Type and press [enter]'); ?>"></textarea> 
	</form>
</div>
<script type="text/javascript">
	require(['jquery'], function($){ 
     	$('#lc-livechat .title').click(function(){
     		if($('#lc-livechat').hasClass('closed')){
     			$('#lc-livechat').removeClass('closed');
     		}else{
     			$('#lc-livechat').addClass('closed');
     		}
     	})
     	$('#lc-message').keypress(function (e) {
		  	if (e.which == 13) {
		    	$('#lc-livechatform').submit();
		    	return false;
		  	}
		});
     	$("#lc-livechatform").submit(function(e) {
		    var url = "<?php echo $this->getFormAction(); ?>";
		    $.ajax({
	           	type: "POST",
	           	url: url,
	           	data: $("#lc-livechatform").serialize(),
	           	success: function(data){
	           		var message = $('#lc-message').val();
	           		$('#lc-livedisc').append('<div class="message customer">'+message+'</div>');
	           		$('#lc-message').val('');
	           		$('#lc-livedisc').animate({bottom: 0});
	           		changeProportions();
	           		console.log('Success!');
	               	console.log(data);
	           	},
	            error: function (data) {
	                console.log('An error occurred.');
	                console.log(data);
	            }
		    });
		    e.preventDefault();
		});
		function changeProportions(){
			var L = $('#lc-livedisc').height();
			var l = 230;
			var H = 230;
			var h = 0;
			console.log('L='+L);
			var p = L / l; //   p = Proportion
			console.log('p='+p);

			if (p <= 1){
				console.log('p <= 1');
			}else{
				console.log('p > 1');
				if($('#lc-discussion').find('#lc-scrollBar').length !== 0){
					console.log('#lc-discussion has #lc-scrollBar');
					setAppropriateScrollbarHeight();
				}else{
					console.log('#lc-discussion doesn\'t have #lc-scrollBar');
					$('#lc-discussion').prepend('<div id="lc-scrollBar"><div id="lc-slider"></div></div>');
					setAppropriateScrollbarHeight();
					$("#lc-scrollBar").mousedown(function(e){
					    var cursorY = e.clientY || window.event.clientY;
					    var scrollBarYPosition = $('#lc-scrollBar')[0].getBoundingClientRect().top;

					    var difference = cursorY - scrollBarYPosition;

					    var lcSliderHeight = document.getElementById('lc-slider').clientHeight;

					    if((lcSliderHeight/2) >= difference){
					    	$('#lc-slider').css('top', 0 + 'px');
					    }else{
					    	$('#lc-slider').css('top', (difference - (lcSliderHeight/2))  + 'px');
					    }

					    $('.page-title').html('cursorY = '+cursorY+'<br> scrollBarYPosition = '+scrollBarYPosition+'<br> cursorY - scrollBarYPosition = '+(cursorY - scrollBarYPosition));
					});
				}
			}
		}
		function setAppropriateScrollbarHeight(){
			var L = $('#lc-livedisc').height();
			var l = 230;

			var H = 230;
			var h = 0;


			h = (H*l)/L;
			if(h < 10){
				$('#lc-slider').height(10);
				$('#lc-slider').css('top', (H-10) + 'px');
			}else{
				$('#lc-slider').height(h);
				$('#lc-slider').css('top', (H-h) + 'px');
			}
		}
 	});
</script>